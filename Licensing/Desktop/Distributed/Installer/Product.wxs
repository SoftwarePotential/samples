<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" >
  <?include Variables.wxi ?>
  <Product Id="*" Name="$(var.DistributorVendor) $(var.DistributorProductName)" Version="$(var.DistributorProductVersion)"
    Manufacturer="$(var.DistributorVendor)" Language="1033" UpgradeCode="$(var.DistributorProductUpgradeCode)">
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." AllowSameVersionUpgrades="yes" />
    <Media Id="1" Cabinet="cab1.cab" EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="$(var.DistributorVendor) $(var.DistributorProductName)">
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="DistributorFeature" Title="DistributorSetup" Level="1">
      <ComponentRef Id="DistributorService"/>
      <!--A .wxs file referencing all Distributor Server files is being generated by the WiX HarvestDirectory target -->
      <!--See also Sp.Distributor.Wix.props and Sp.Distributor.Wix.targets files--> 
      <ComponentGroupRef Id="DistributorFilesComponentGroup" />
    </Feature>

    <CustomAction Id="InstallDistributorService"    Directory="INSTALLFOLDER" Execute="deferred"  ExeCommand="[INSTALLFOLDER]install.cmd -install" Return="check"  Impersonate="no" />
    <CustomAction Id="UninstallDistributorService"  Directory="INSTALLFOLDER" Execute="deferred"  ExeCommand="[INSTALLFOLDER]install.cmd -uninstall" Return="check" Impersonate="no"  />
    <InstallExecuteSequence>
      <Custom Action="InstallDistributorService"    Before="InstallFinalize">(NOT Installed OR UPGRADINGPRODUCTCODE) AND NOT REMOVE="ALL"</Custom>
      <Custom Action="UninstallDistributorService"  Before="RemoveFiles">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>
  </Product>

  <Fragment>
    <DirectoryRef Id="TARGETDIR">
      <Component Id="DistributorService" Guid="F31420A7-BD27-4262-A06E-3B3A784A255E">
        <!--Stop the service on uninstallation to prevent a 'Files in use' pop-up during InstallValidate -->
        <!--'[INSTALLFOLDER]install.cmd -stop' cannot be used for that because of problems with running immediate custom actions requiring elevated privileges on UAC enabled machines -->
        <ServiceControl Name="Slps.Distributor.Host" Stop="uninstall" Id="StopService" />
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
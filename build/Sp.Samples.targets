<?xml version="1.0" encoding="utf-8" ?>
<!--
* Copyright (c) Inish Technology Ventures Limited.  All rights reserved.
*
* This code is licensed under the BSD 3-Clause License included with this source
*
* ALSO SEE: https://github.com/SoftwarePotential/samples/wiki/License -->
<Project ToolsVersion="4.0" InitialTargets="ValidateSdkPath"  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(MSBuildProjectDirectory)\SpAgent.props" />

  <PropertyGroup>
    <BuildDependsOn>
      ValidatePermutationId;
      $(BuildDependsOn);
    </BuildDependsOn>
  </PropertyGroup>

  <Target Name="ValidateSdkPath">
    <Error Text="This sample requires the Software Potential Sdk from http://inishtech.com to be installed to work correctly"
      Condition=" '$(SlpsSdkPath)' == '' OR !Exists('$(SlpsSdkPath)\Slps.Runtime.References.targets')" />
  </Target>

  <Target Name="ValidatePermutationId">
    <Message Text="Metrics: $(ShortId.Length) $(SlpsRuntimePermutationId.Length) " />
    <Error Text="This Sample has not yet been customized for your Software Potential Permutation Id. Please run ConfigureSample.cmd." 
      Condition=" $(ShortId.Length) != 5 OR $(SlpsRuntimePermutationId.Length) != 36 " />
  </Target>

  <Import Project="$(SlpsSdkPath)\Slps.Runtime.References.targets"
    Condition=" Exists('$(SlpsSdkPath)\Slps.Runtime.References.targets') AND ( $(ShortId.Length) == 5 OR $(SlpsRuntimePermutationId.Length) == 36 ) " />

  <Target Name="StripPermutationInfo">
    <PropertyGroup>
      <_CsContent>
        <![CDATA[
namespace $(RootNamespace)
{
	partial class SpAgent
	{
#error "PLACEHOLDER FILE ONLY. TODO: Please make this file writable and run a build to generate correct content."
		public const string PermutationShortId = "PLACEHOLDER FILE ONLY. TODO: Please make this file writable and run ConfigureSample.cmd generate correct content."%3B 
	}
}
]]>
      </_CsContent>
    </PropertyGroup>

    <XmlPoke Namespaces="&lt;Namespace Prefix='msb' Uri='http://schemas.microsoft.com/developer/msbuild/2003'/&gt;"
            XmlInputPath="SpAgent.props"
            Query="/msb:Project/msb:PropertyGroup/msb:SlpsRuntimePermutationId"
            Value="TODO - Please run ConfigureSample.cmd" />

      <XmlPoke Namespaces="&lt;Namespace Prefix='msb' Uri='http://schemas.microsoft.com/developer/msbuild/2003'/&gt;"
              XmlInputPath="SpAgent.props"
              Query="/msb:Project/msb:PropertyGroup/msb:ShortId"
              Value="TODO - Please run ConfigureSample.cmd" />
    <WriteLinesToFile File="$(MSBuildProjectDirectory)\SpAgent.Permutation.cs" Lines="$(_CsContent)" Overwrite="true" />
  </Target>

  <Target Name="ConfigurePermutationInfo">
    <Error Text="Please supply a SlpsRuntimePermutationId property when invoking this Target." Condition=" '$(SlpsRuntimePermutationId)' == '' " />
    <PropertyGroup>
      <_ShortId>$(SlpsRuntimePermutationId.SubString(0,5))</_ShortId>
    </PropertyGroup>
    <!--TODO xmlpoke replace Project / PropertyGroup / SlpsRuntimePermutationId with value
    TODO xmlpoke replace Project / PropertyGroup / ShortId with value -->

    <XmlPoke Namespaces="&lt;Namespace Prefix='msb' Uri='http://schemas.microsoft.com/developer/msbuild/2003'/&gt;"
            XmlInputPath="SpAgent.props"
            Query="/msb:Project/msb:PropertyGroup/msb:SlpsRuntimePermutationId"
            Value="$(SlpsRuntimePermutationId)" />

    <XmlPoke Namespaces="&lt;Namespace Prefix='msb' Uri='http://schemas.microsoft.com/developer/msbuild/2003'/&gt;"
            XmlInputPath="SpAgent.props"
            Query="/msb:Project/msb:PropertyGroup/msb:ShortId"
            Value="$(_ShortId)" />
    <PropertyGroup>
      <_CsContent>
        <![CDATA[
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
namespace $(RootNamespace)
{
	partial class SpAgent
	{
		// NOTE: This value needs to reflect the specific permutation package you are using to protect your app
		const string PermutationShortId = "$(_ShortId)"%3B 
	 }
}]]>
      </_CsContent>
    </PropertyGroup>
    <WriteLinesToFile File="$(MSBuildProjectDirectory)\SpAgent.Permutation.cs" Lines="$(_CsContent)" Overwrite="true" />
  </Target>
</Project>
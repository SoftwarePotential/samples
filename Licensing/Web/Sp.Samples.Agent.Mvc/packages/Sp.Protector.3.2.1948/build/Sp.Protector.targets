<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" InitialTargets="ValidateIncomingPropsSatisfied" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="ValidateIncomingPropsSatisfied">
    <Error Condition=" '' == '$(SpProtectorPackageToolsProtectorCmdPath)' " Text="Please ensure the associated Sp.Protector.props is included at the top of the .&lt;lang&gt;proj file" />
  </Target>

  <PropertyGroup>
    <_SdkToolsBinDir Condition=" '' == '$(_SdkToolsBinDir)' ">$(TargetFrameworkSDKToolsDirectory)</_SdkToolsBinDir>
    <SpProtectorSnToolPath Condition=" '' == '$(SpProtectSnTool)' ">$(_SdkToolsBinDir)SN.exe</SpProtectorSnToolPath>
    <SlpsSdkProtectSnTool Condition=" '' == '$(SlpsSdkProtectSnTool)' ">$(SpProtectorSnToolPath)</SlpsSdkProtectSnTool>
    <CoreSpProtectDependsOn>ValidateSnToolPathIfSigning;$(CoreSpProtectDependsOn)</CoreSpProtectDependsOn>
    <SlpsSdkProtectorCmdFilepath Condition="'$(SlpsSdkProtectorCmdFilepath)'==''">$(SpProtectorPackageToolsProtectorCmdPath)</SlpsSdkProtectorCmdFilepath>

    <SpProtect_Substitutions_Before Condition=" 'true' != '$(SpSkipRuntimeVariant)' ">$(SpProtect_Substitutions_Before),Global/TargetCLRVersion=$(SpRuntimeVariant)</SpProtect_Substitutions_Before>

    <SpProtect_Substitutions_Before Condition=" 'true' != '$(SpSkipPermutationId)' ">$(SpProtect_Substitutions_Before),Global/Permutation=$(SpPermutationId)</SpProtect_Substitutions_Before>
    <SpProtect_Substitutions_Before Condition=" 'true' != '$(SpSkipPermutationDir)' ">$(SpProtect_Substitutions_Before),Global/PermutationDir=$(SpPermutationDir)</SpProtect_Substitutions_Before>

    <SpProtect_Substitutions_Before Condition=" 'true' != '$(SpSkipProductNameVersion)' AND 'true' != '$(SpSkipProductName)' ">$(SpProtect_Substitutions_Before),Global/ProductName=$(SpProductName)</SpProtect_Substitutions_Before>
    <SpProtect_Substitutions_Before Condition=" 'true' != '$(SpSkipProductNameVersion)' AND 'true' != '$(SpSkipProductVersion)' ">$(SpProtect_Substitutions_Before),Global/ProductVersion=$(SpProductVersion)</SpProtect_Substitutions_Before>
  </PropertyGroup>

  <!-- http://stackoverflow.com/a/16464894/11635 -->
  <Target Name="ValidateSnToolPathIfSigning" Condition=" 'true' == '$(SignAssembly)' ">
    <Error Condition=" 'true' == '$(SignAssembly)' AND !EXISTS( '$(SlpsSdkProtectSnTool)' )"
      Text="In order to resign the assembly after protection, the Sp.Protect NuGet package requires access to the SN.EXE tool from the Windows Platform SDK, which was not found.

The location derived was &quot;$(SlpsSdkProtectSnTool)&quot;.

Please either:
1) supply a correct path to your SDK Tools bin directory containing SN.EXE by setting %24(_SdkToolsBinDir) or %24(TargetFrameworkSDKToolsDirectory)
OR
2) supply a correct complete path to your SN.EXE signing tool by setting %24(SpProtectorSnToolPath)" />
  </Target>

  <!-- Programming-by-coincidence a la the rest of NuGet:- Conditional is required as NuGet is fond of leaving the packages in inconsistent states during Uninstall-Package -->
  <Import Project="$(SpProtectorPackageToolsPath)\Slps.Protector.targets" Condition=" EXISTS( '$(SpProtectorPackageToolsPath)\Slps.Protector.targets' ) " />
</Project>